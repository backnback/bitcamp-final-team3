<!DOCTYPE html>
<html>
<head data-th-replace="~{header :: head}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<header data-th-replace="~{header :: #page-header}"></header>
<body>
<div class="container my-5" style="max-width: 1200px; margin: 0 auto;">
    <h1 class="text-center my-5 mb-4">일정 질문 작성하기</h1>

    <form method="post" data-th-action="@{/question/add}" class="mb-4">

    <div class="mb-1">
        <select id="tripSelect" class="form-select" onchange="loadScheduleList(this.value)">
            <option value="">여행을 선택하세요</option>
            <option data-th-each="trip : ${trips}" data-th-text="${trip.tripTitle}" data-th-value="${trip.tripNo}"></option>
        </select>
    </div>

    <div id="scheduleContainer" class="d-flex overflow-auto p-3 gap-3">
        <!-- 데이터는 JavaScript로 추가 -->
    </div>

        <input id="selectedTripNo" name="tripNo" type="hidden">

        <div class="mb-3">
            <input id="boardTitle" name="boardTitle" placeholder="제목을 입력해 주세요." type="text" class="form-control">
        </div>

        <div class="mb-3">
            <textarea id="boardContent" name="boardContent" placeholder="내용을 입력해 주세요." style="height: 200px; overflow-y: auto; resize: none;" class="form-control"></textarea>
        </div>


        <div class="mb-3">
            <input id="boardTag" name="boardTag" placeholder="#태그를 입력해 주세요." type="text" class="form-control">
        </div>

        <div class="d-flex justify-content-end">
            <input type="submit" value="등록" class="btn btn-primary me-2">
            <button data-th-onclick="|location.href='@{/question/list}'|" type="button" class="btn btn-secondary">취소</button>
        </div>
    </form>
</div>

<script>
    function loadScheduleList(tripNo) {
    if (tripNo) {
        fetch(`/question/getScheduleList?tripNo=${tripNo}`)
            .then(response => response.json())
            .then(data => {
                const scheduleContainer = document.getElementById('scheduleContainer');
                scheduleContainer.innerHTML = ''; // 기존 데이터 초기화

                if (data.length > 0) {
                    // 데이터를 일차별로 그룹화
                    const groupedSchedules = data.reduce((acc, schedule) => {
                        const day = schedule.scheduleDay; // 일차 정보
                        if (!acc[day]) acc[day] = [];
                        acc[day].push(schedule);
                        return acc;
                    }, {});

                    Object.keys(groupedSchedules).forEach(day => {
                        const dayColumn = document.createElement('div');
                        dayColumn.classList.add('col-md-4', 'mb-3', 'd-inline-block');
                        dayColumn.style.width = '300px';
                        dayColumn.style.marginRight = '5px';

                        // 일차 및 날짜 표시
                        const dayHeader = document.createElement('div');
                        dayHeader.classList.add('d-flex', 'justify-content-between', 'align-items-center', 'mb-1');
                        dayHeader.innerHTML = `
                            <h5 class="text-start fw-bold" style="font-size: 1.2rem;">${day}일차</h5>
                            <span class="text-muted text-end" style="font-size: 1rem;">
                                ${new Date().toLocaleDateString()}
                            </span>
                        `;
                        dayColumn.appendChild(dayHeader);

                        // 일정 리스트
                        groupedSchedules[day].forEach((schedule, index) => {
                            const scheduleCard = document.createElement('div');
                            scheduleCard.classList.add('timeline-item', 'mb-1');

                            scheduleCard.innerHTML = `
                                <div class="p-3 border rounded shadow-sm d-flex justify-content-between align-items-center">
                                    <div class="me-2 align-items-start">
                                        <div class="d-flex">
                                            <div class="badge bg-warning text-white" style="font-size: 1rem; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;">
                                                ${index + 1}
                                            </div>
                                            <div class="ms-2">
                                                <p class="mb-1 text-secondary" style="font-size: 0.9rem;">
                                                    ${schedule.startTime || '16:00'} ~ ${schedule.endTime || '16:30'}
                                                </p>
                                                <p class="mb-1 text-primary" style="font-size: 0.9rem;">
                                                    ${schedule.thema || '테마 이름'}
                                                </p>
                                                <p class="mb-1" style="font-size: 0.9rem;">
                                                    ${schedule.location ? schedule.location.locationName : '지역'}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <img src="${schedule.location && schedule.location.locationPhoto ? schedule.location.locationPhoto : 'https://via.placeholder.com/70x70'}"
                                             alt="Location Photo" class="img-thumbnail" style="width: 70px; height: 70px;">
                                    </div>
                                </div>
                                ${index < groupedSchedules[day].length - 1 ? `
                                    <div class="d-flex align-items-center" style="height: 20px;">
                                        <div class="timeline-line mt-2" style="border-left: 2px dotted #ddd; height: 70%; margin-left: 15px;"></div>
                                        <div class="text-muted small ms-2" style="font-size: 0.8rem; margin-top: 6px;">
                                            <i class="bi bi-car-front"></i> ${schedule.travelTime || '45'}분
                                        </div>
                                    </div>` : ''}
                            `;
                            dayColumn.appendChild(scheduleCard);
                        });

                        scheduleContainer.appendChild(dayColumn);
                    });
                } else {
                    scheduleContainer.innerHTML = '<p class="text-danger">일정 데이터가 없습니다.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching schedule:', error);
            });
    }
}
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
