<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
          name="viewport">
    <title>간단한 지도 표시하기</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0zojwabqn9&submodules=geocoder"
            type="text/javascript"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container-fluid" style="height: 100vh;">
    <div class="row" style="height: 100vh;">
        <div class="col-4">
            <div class="row position-relative" style="height: 100vh;">
                <nav class="col-xl-3 boarder border-dark">
                    <h4 class="text-dark text-center">모두의<br>여행</h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-dark text-center" href="/home">메뉴 1</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark text-center" href="#">메뉴 2</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark text-center" href="#">메뉴 3</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark text-center" href="#">메뉴 4</a>
                        </li>
                    </ul>
                    <div class="d-flex justify-content-center mb-4">
                        <button class="btn btn-primary btn-sm" id="nextPageBtn" type="button">다음</button>
                    </div>
                </nav>
                <div class="col-xl-9 " style="height: 100vh; overflow-y: auto;">
                    <button class="btn btn-sm bg-dark text-white"
                            data-bs-target="#subColumn3"
                            data-bs-toggle="collapse">버튼
                    </button>

                    <div class="container">
                        <div class="row">
                            <div class="col-md-6 d-flex justify-content-center mb-2">
                                <!-- 장소선택 버튼 -->
                                <button class="btn custom-btn custom-btn-blue w-100" id="showLocationListBtn"
                                        type="button">장소선택
                                </button>
                            </div>

                            <div class="col-md-6 d-flex justify-content-center mb-2">
                                <!-- 장소추가 버튼 -->
                                <button class="btn custom-btn custom-btn-blue w-100" id="showAddLocationBtn"
                                        type="button">장소추가
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 위치 리스트 영역 -->
                    <div class="my-4" id="locationListDiv" style="width: 100%; overflow-y: auto;">
                        <div class="mb-2" data-th-each="location, status : ${locationList}"
                             data-th-object="${location}">
                            <div class="card" style="width: 100%; height: 100px;">
                                <div class="card-body d-flex align-items-center justify-content-between border">
                                    <!-- 이미지 영역 -->
                                    <img alt="Location Image" class="rounded me-3 h-100"
                                         data-th-src="${location.locationPhoto} ?: '/images/default.jpg'"
                                         style="width: 70px; object-fit: cover;">

                                    <!-- 텍스트 정보 영역 -->
                                    <div class="d-flex flex-column" style="flex: 1;">
                                        <h5 class="card-title mb-1" data-th-text="*{locationName}"
                                            style="font-size: 16px;">
                                            여행지이름</h5>
                                        <p class="card-text text-muted mb-0" data-th-text="*{locationAddr}"
                                           style="font-size: 12px;">
                                            주소</p>
                                    </div>

                                    <!-- 버튼 영역 -->
                                    <button class="btn btn-outline-secondary btn-location d-flex justify-content-center align-items-center"
                                            data-th-attr="data-index=${status.index}"
                                            style="height: 60px; width: 30px;">
                                        <i class="bi bi-plus-lg"></i>
                                        <span class="location-x d-none" data-th-text="*{locationX}"></span>
                                        <span class="location-y d-none" data-th-text="*{locationY}"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- Positioned Sub Column 3 to appear on the right of Sub Column 2 -->
                <div class="col-xl-9 collapse show bg-white text-white position-absolute start-100 h-100"
                     id="subColumn3" style="z-index: 1; height: 100vh; overflow-y: auto;">
                    <div class="my-4" id="appendMyLocation" style="width: 100%; overflow-y: auto;">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-8 bg-white text-primary" id="map" style="height: 100vh;"></div>

        <div aria-hidden="true" aria-labelledby="dateModalLabel" class="modal fade" data-bs-backdrop="static"
             data-bs-keyboard="false"
             id="dateModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dateModalLabel">여행 날짜 선택</h5>
                    </div>
                    <div class="modal-body">
                        <form id="dateForm">
                            <div class="mb-3">
                                <label class="form-label" for="startDate">시작 날짜</label>
                                <input class="form-control" id="startDate" name="startDate" required type="date">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="endDate">종료 날짜</label>
                                <input class="form-control" id="endDate" name="endDate" required type="date">
                            </div>
                            <div class="text-end">
                                <button class="btn btn-primary" type="submit">저장</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<script data-th-inline="javascript">
    // 페이지 로드 시 실행될 코드
    document.addEventListener('DOMContentLoaded', function () {
        const startDate = /*[[${trip.startDate}]]*/ null;
        const modal = new bootstrap.Modal(document.getElementById('dateModal'));

        if (!startDate) {
            modal.show();
        }

        document.getElementById('dateForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;


            const formData = new FormData();
            formData.append('startDate', startDate);
            formData.append('endDate', endDate);

            fetch('/schedule/saveDates', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(result => {
                    modal.hide();
                });
        });

        document.getElementById('startDate').addEventListener('change', function () {
            document.getElementById('endDate').min = this.value;
        });
    });

    // 전역 변수로 지도 객체 선언
    let map = null;

    // 줌 레벨 상수
    const ZOOM_LEVELS = {
        'area1': 11,  // 시/도
        'area2': 13,  // 시/군/구
        'area3': 15,  // 읍/면/동
        'area4': 17   // 리
    };

    // DOM 로드 시 지도 초기화
    document.addEventListener('DOMContentLoaded', () => {
        // Thymeleaf 변수
        const stateName = /*[[${trip.city.state.stateName}]]*/ '';
        const cityName = /*[[${trip.city.cityName}]]*/ '';
        let regionType = 'area1';

        // 도시명이 '전체'인 경우 처리
        const searchQuery = cityName === "전체" ? stateName : cityName;

        // 주소 검색 및 지도 초기화
        naver.maps.Service.geocode({
            query: searchQuery
        }, function (status, response) {
            if (status !== naver.maps.Service.Status.OK) {
                console.error('지도 초기화 실패');
                return;
            }

            const items = response.v2.addresses;
            if (items.length === 0) {
                console.error('주소를 찾을 수 없습니다');
                return;
            }

            const {x: mapx, y: mapy} = items[0];
            const centerPosition = new naver.maps.LatLng(mapy, mapx);
            const zoomLevel = ZOOM_LEVELS[regionType] || ZOOM_LEVELS.area2;

            // 지도가 없으면 새로 생성, 있으면 위치만 업데이트
            if (!map) {
                map = new naver.maps.Map('map', {
                    center: centerPosition,
                    zoom: zoomLevel
                });
            } else {
                map.setCenter(centerPosition);
                map.setZoom(zoomLevel);
            }
        });
    });

    let markerList = [];

    function addMarker(locationX, locationY) {
        let pos = new naver.maps.LatLng(locationY, locationX);
        let marker = new naver.maps.Marker({
            position: pos,
            map: map,
        });

        // 마커에 위치 속성 추가하여 나중에 참조 가능
        marker.locationX = locationX;
        marker.locationY = locationY;

        // markerList에 추가
        markerList.push(marker);
    }

    // 마커 제거 함수
    function removeMarker(locationX, locationY) {
        // markerList에서 해당 좌표를 가진 마커 찾기
        markerList = markerList.filter(marker => {
            const isMatch = marker.locationX === locationX && marker.locationY === locationY;
            if (isMatch) {
                marker.setMap(null); // 지도에서 마커 제거
            }
            return !isMatch; // 일치하는 마커는 리스트에서 제거
        });
    }

    const locationListDiv = document.getElementById("locationListDiv");
    const addBtns = locationListDiv.querySelectorAll(".btn");
    addBtns.forEach(button => {
        button.addEventListener('click', () => {
            const locationX = button.querySelector('.location-x').textContent;
            const locationY = button.querySelector('.location-y').textContent;
            const index = button.getAttribute("data-index");
            const icon = button.querySelector('i');

            button.classList.remove("btn-outline-secondary");
            button.classList.add("btn-primary");

            icon.classList.remove("bi-plus-lg");
            icon.classList.add("bi-check-lg");

            /////여기서 에드 마커 하지 말장
            addMarker(locationX, locationY)
            addLocation(index);
        });
    });

    function renderLocationCards(data) {
        const container = document.getElementById("appendMyLocation");
        container.innerHTML = ''; // 기존 리스트 비우기

        // 반환된 selectLoList 배열을 순회하며 동적으로 HTML 생성
        data.forEach((location, index) => {
            const locationDiv = document.createElement("div");
            locationDiv.classList.add("card", "mb-3");
            locationDiv.style.width = "100%";
            locationDiv.style.height = "100px";

            // Card Body
            const cardBody = document.createElement("div");
            cardBody.classList.add("card-body", "d-flex", "align-items-center", "justify-content-between", "border", "gap-2");

            // 넘버링 서클
            const numberCircle = document.createElement("div");
            numberCircle.classList.add("d-flex", "justify-content-center", "align-items-center", "rounded-circle", "bg-primary", "text-white");
            numberCircle.style.width = "20px";
            numberCircle.style.height = "20px";
            numberCircle.style.fontSize = "10px";
            numberCircle.textContent = index + 1; // index에 따라 넘버링

            // 이미지 영역
            const image = document.createElement("img");
            image.classList.add("rounded", "me-3", "h-100");
            image.alt = "Location Image";
            image.src = location.locationPhoto || '/images/default.jpg'; // 기본 이미지 경로 설정
            image.style.width = "70px";
            image.style.objectFit = "cover";

            // 텍스트 정보 영역
            const textContainer = document.createElement("div");
            textContainer.classList.add("d-flex", "flex-column");
            textContainer.style.flex = "1";

            const title = document.createElement("h5");
            title.classList.add("card-title", "mb-1");
            title.style.fontSize = "16px";
            title.textContent = location.locationName;

            const addr = document.createElement("p");
            addr.classList.add("card-text", "text-muted", "mb-0");
            addr.style.fontSize = "12px";
            addr.textContent = location.locationAddr;

            textContainer.appendChild(title);
            textContainer.appendChild(addr);

            // 버튼 영역
            const button = document.createElement("button");
            button.classList.add("btn", "btn-outline-secondary", "btn-location", "d-flex", "justify-content-center", "align-items-center");
            button.style.height = "60px";
            button.style.width = "30px";
            button.setAttribute("data-index", index);

            const icon = document.createElement("i");
            icon.classList.add("bi", "bi-trash"); // trash 아이콘 추가
            button.appendChild(icon);

            const spanX = document.createElement("span");
            spanX.classList.add("location-x", "d-none");
            spanX.textContent = location.locationX;
            button.appendChild(spanX)

            const spanY = document.createElement("span");
            spanY.classList.add("location-y", "d-none");
            spanY.textContent = location.locationY; // location 객체의 locationY 값을 설정
            button.appendChild(spanY);

            // Card Body에 구성 요소 추가
            cardBody.appendChild(numberCircle);
            cardBody.appendChild(image);
            cardBody.appendChild(textContainer);
            cardBody.appendChild(button);

            // locationDiv에 cardBody 추가
            locationDiv.appendChild(cardBody);

            // container에 locationDiv 추가
            container.appendChild(locationDiv);
        });
    }

    function addLocation(index) {
        fetch(`/schedule/appendMyLocation?index=${index}`)
            .then(response => response.json())
            .then(data => renderLocationCards(data))
            .catch(error => console.error("Error:", error));
    }

    const appendMyLocation = document.getElementById("appendMyLocation");
    appendMyLocation.addEventListener('click', (event) => {
        if (event.target.classList.contains("btn")) {
            const button = event.target.closest(".btn-location");
            const locationX = button.querySelector('.location-x').textContent;
            const locationY = button.querySelector('.location-y').textContent;
            const index = button.getAttribute("data-index");
            console.log("Button clicked with index:", index);
            stataChange(locationX, locationY);
            deleteLocation(index);
            removeMarker(locationX, locationY);
        }
    });

    function deleteLocation(index) {
        fetch(`/schedule/deletedMyLocation?index=${index}`)

            .then(response => response.json())
            .then(data => {
                renderLocationCards(data); // 리스트 렌더링
            })
            .catch(error => console.error("Error:", error));
    }

    function stataChange(locationXd, locationYd) {
        // 모든 카드 요소를 순회하면서 제목과 주소가 일치하는 카드 찾기
        document.querySelectorAll('.btn-location').forEach(button => {
            const locationX = button.querySelector('.location-x').textContent
            const locationY = button.querySelector('.location-y').textContent

            // 제목과 주소가 일치하는 카드의 버튼과 아이콘 업데이트
            if (locationX === locationXd && locationY === locationYd) {
                const icon = button.querySelector('i');
                button.classList.remove("btn-primary");
                button.classList.add("btn-outline-secondary");

                icon.classList.remove("bi-check-lg");
                icon.classList.add("bi-plus-lg");
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const nextButton = document.getElementById("nextPageBtn"); // 버튼 선택

        nextButton.addEventListener("click", function () {
            // 클릭 시 수행할 작업을 여기에 작성
            location.href = "/schedule/selectHotel";
            // 여기에 원하는 로직 추가
        });
    });
</script>
</body>
</html>
