<!DOCTYPE html>
<html>

<head data-th-replace="~{header :: head}"></head>
<header data-th-replace="~{header :: #page-header}"></header>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<body>
<div class="container mt-5">
    <h1 class="mb-4">게시글 수정</h1>

    <!-- 데이터 확인용 -->
    <div class="alert alert-info" role="alert" data-th-if="${trips.size() > 0}">
        디버깅용: Trip 데이터가 존재합니다.
    </div>
    <div class="alert alert-warning" role="alert" data-th-unless="${trips.size() > 0}">
        Trip 데이터가 없습니다.
    </div>

    <!-- 게시글이 없을 경우 -->
    <div class="alert alert-danger mt-4" data-th-unless="${board}">없는 게시글입니다.</div>

    <!-- 게시글이 있을 경우 -->
    <form data-th-if="${board}" th:action="@{update}" method="post" class="mt-4">
        <div class="mb-3">
            <label for="no" class="form-label">게시글 번호</label>
            <input id="no" name="no" type="text" class="form-control" readonly th:value="${board.boardNo}">
        </div>

        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input id="title" name="title" type="text" class="form-control" th:value="${board.boardTitle}">
        </div>


        <!-- 여행 정보 -->
        <table class="table table-bordered">
            <thead class="table-light">
            <tr>
                <th>여행번호</th>
                <th>여행제목</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><span data-th-text="${board.trip.tripNo}">번호</span></td>
                <td><span data-th-text="${board.trip.tripTitle}">제목</span></td>
            </tr>
            </tbody>
        </table>

        <!-- 일정 리스트 -->
        <div id="scheduleContainer" class="mt-4">
            <h2 class="mb-4">일정 리스트</h2>
            <div id="scheduleList" class="list-group">
                <div class="list-group-item" data-th-each="schedule, status : ${schedule}" data-th-object="${schedule}">
                    <div class="d-flex align-items-start mb-3">
                        <span class="me-3 badge bg-secondary">일정번호: <span data-th-text="*{scheduleNo}">번호</span></span>
                        <span class="me-3">제목: <span data-th-text="*{location.locationName}">제목</span></span>
                        <span class="me-3">Day: <span data-th-text="*{scheduleDay}">Day</span></span>
                        <span class="me-3">순서: <span data-th-text="*{scheduleRoute}">순서</span></span>
                        <textarea name="scheduleContents" class="form-control" rows="3" placeholder="내용을 입력하세요"
                                  data-th-text="${#lists.size(board.boardContent.split('\n')) > status.index ? board.boardContent.split('\n')[status.index] : ''}">
          </textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="boardTag" class="form-label">태그</label>
            <input id="boardTag" name="boardTag" type="text" class="form-control" data-th-value="${board.boardTag}">
        </div>

        <textarea name="content" id="boardContent" style="display:none;" th:text="${board.boardContent}"></textarea>
        <input type="hidden" name="tripNo" id="tripNo" th:value="${board.tripNo}">

        <!-- 기존 첨부 이미지 미리보기 -->
        <div id="existingImagesContainer" class="mb-3">
            <h5>기존 첨부 이미지</h5>
            <div data-th-each="image : ${board.boardImages}" class="d-inline-block position-relative m-2">
                <img data-th-src="@{'https://dgg7dnk35523.edge.naverncp.com/HZiW9aEJy7/review/' + ${image.boardimageName}}" class="img-thumbnail" style="width: 100px; height: 100px;">
                <p class="text-center mt-1" data-th-text="${image.boardimageDefaultName}"></p>
                <button type="button" class="btn-close position-absolute top-0 end-0"
                        onclick="removeExistingImage([[${image.boardimageNo}]])"></button>
            </div>
        </div>

        <!-- 새 파일 첨부 버튼 -->
        <div class="mb-3">
            <label for="file-upload" class="form-label">파일 첨부</label>
            <input id="file-upload" name="imageFile" type="file" class="form-control" multiple onchange="previewImages()">
        </div>

        <!-- 미리보기 컨테이너 -->
        <div id="previewContainer" class="mb-3"></div>

        <script>
            function removeExistingImage(imageId) {
                // hidden input field to keep track of deleted image IDs
                const deletedImagesInput = document.getElementById('deletedImages');
                deletedImagesInput.value += imageId + ','; // add the image ID to be deleted
                document.querySelector(`[data-image-id="${imageId}"]`).remove(); // remove the image preview
            }
        </script>

        <input type="hidden" name="deletedImages" id="deletedImages">

        <script>
            function previewImages() {
                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = ''; // 기존 미리보기 초기화

                const files = document.getElementById('file-upload').files;
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewItem = document.createElement('div');
                        previewItem.classList.add('d-inline-block', 'position-relative', 'm-2');

                        previewItem.innerHTML = `
                    <img src="${e.target.result}" class="img-thumbnail" style="width: 100px; height: 100px;">
                    <p class="text-center mt-1">${file.name}</p>
                    <button type="button" class="btn-close position-absolute top-0 end-0" onclick="removeImage(${index})"></button>
                `;

                        previewContainer.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                });
            }

            function removeImage(index) {
                const fileInput = document.getElementById('file-upload');
                const dt = new DataTransfer();

                Array.from(fileInput.files).forEach((file, i) => {
                    if (i !== index) dt.items.add(file); // 선택한 인덱스 제외
                });

                fileInput.files = dt.files;
                previewImages(); // 미리보기 다시 로드
            }
        </script>

        <button type="button" onclick="location.href='list'" class="btn btn-secondary me-2">목록</button>
        <button type="submit" class="btn btn-primary">변경</button>
    </form>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 폼 제출 시 각 일정의 내용을 \n 단위로 병합하여 hidden textarea로 저장
    document.querySelector('form').addEventListener('submit', function(event) {
        const scheduleContents = Array.from(document.getElementsByName('scheduleContents')).map(textarea => textarea.value);
        document.getElementById('boardContent').value = scheduleContents.join('\n');
    });
</script>

</body>
</html>