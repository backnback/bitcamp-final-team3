<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">

<head data-th-replace="~{header :: head}"></head>
<header data-th-replace="~{header :: #page-header}"></header>
<link data-th-href="@{/css/review.css}" rel="stylesheet">
<h1 class="text-center mb-4">여행 후기 게시판</h1>

<body>
<!-- 게시글이 없는 경우 -->
<p data-th-unless="${board}">없는 게시글입니다.</p>

<!-- 게시글이 있는 경우 -->
<div data-th-if="${board}" class="container my-5" style="max-width: 1200px; margin: 0 auto;">
    <form id="myForm" data-th-action="@{modify}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="boardNo" data-th-value="${board.boardNo}">

        <div class="mb-3">
            <h2 class="form-title" style="margin-left: 10px; font-size: 1.8rem; font-weight: bold;" data-th-text="${board.boardTitle}"/>
        </div>

        <div class="border-bottom pb-3 mb-1">
            <div class="d-flex align-items-center mb-3">
                <img data-th-src="${board.writer.userPhoto != null ? board.writer.userPhoto : 'https://via.placeholder.com/60x60'}"
                     alt="User Photo" class="rounded-circle me-3" style="width: 60px; height: 60px;">
                <div>
                    <h5 class="mb-1" data-th-text="${board.writer.userNickname}">닉네임</h5>
                    <small class="text-muted">
                        작성일: <span data-th-text="${#dates.format(board.boardCreatedDate, 'yyyy.MM.dd HH:mm')}">날짜</span>
                        • 조회: <span data-th-text="${board.boardCount}">조회수</span>
                    </small>
                </div>
                <div class="ms-auto">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="location.href='list'">목록</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-th-if="${session.loginUser != null and session.loginUser.userNo == board.writer.userNo}" data-th-onclick="document.getElementById('myForm').submit();">수정</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-th-if="${session.loginUser != null and session.loginUser.userNo == board.writer.userNo}" data-th-onclick="|deleteBoard(${board.boardNo})|">삭제</button>
                </div>
            </div>
            <div class="d-flex align-items-center" >
                <button type="button" id="likeButton" class="btn btn-outline-danger btn-sm me-2"
                        data-th-text="${isLiked ? '❤️ 좋아요 취소' : '🤍 좋아요'}"
                        data-th-onclick="toggleLike([[${board.boardNo}]])"></button><br>
                <span id="likeCount" class="me-3" data-th-text="${board.boardLike}">0</span>

                <button type="button" id="favorButton" class="btn btn-outline-warning btn-sm me-2"
                        data-th-text="${isFavored ? '⭐ 즐겨찾기 취소' : '⚪ 즐겨찾기'}"
                        data-th-onclick="toggleFavor([[${board.boardNo}]])"></button>
                <span id="favorCount" class="me-3" data-th-text="${board.boardFavor}">0</span><br>
            </div>
        </div>
    </form>

    <div class="d-flex justify-content-center align-items-center gap-3 my-3" style="margin-left: 100px;">
            <!-- 지도 보여주기 -->
            <div id="map" style="width: 600px; height: 360px;"></div>

            <!-- 이미지 보여주기 -->
            <div class="boardImages">
                <div th:each="image, iter : ${board.boardImages}" class="slide" th:attr="data-index=${iter.index}">
                    <a th:href="${image != null && image.boardimageName != null ? 'https://kr.object.ncloudstorage.com/bitcamp-bucket088a/review/' + image.boardimageName : 'https://kr.object.ncloudstorage.com/bitcamp-bucket088a/review/default.jpg'}">
                        <img th:src="${image != null && image.boardimageName != null ? 'https://dgg7dnk35523.edge.naverncp.com/HZiW9aEJy7/review/' + image.boardimageName + '?type=u&w=600&h=400' : 'https://dgg7dnk35523.edge.naverncp.com/HZiW9aEJy7/review/default.jpg?type=u&w=600&h=400'}" class="img-thumbnail">
                    </a>
                </div>
                <!-- 이미지 네비게이션-->
                <ul class="pagination justify-content-center">
                    <button class="prev btn btn-outline-secondary btn-sm" onclick="changeSlide(-1)">❮</button>
                    <div id="pagination-dots" class="d-inline"></div>
                    <button class="next btn btn-outline-secondary btn-sm" onclick="changeSlide(1)">❯</button>
                </ul>
            </div>
    </div>

        <br><h2>여행 데이터</h2><br>
        <table border="1">
            <thead>
            <tr>
                <th>여행번호</th>
                <th>여행제목</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><span data-th-text="${board.trip.tripNo}">번호</span></td>
                <td><span data-th-text="${board.trip.tripTitle}">제목</span></td>
            </tr>
            </tbody>
        </table>

        <!-- 일정 데이터와 boardContent 내용을 함께 출력 -->
        <br><h2>일정 데이터</h2><br>
        <span data-th-if="${schedule}" data-th-data="${schedule.size()}">
    <p>디버깅용 : Schedule 데이터가 존재합니다.</p>
</span>
        <span data-th-unless="${schedule}">
    <p>디버깅용 : Schedule 데이터가 없습니다.</p>
</span>

        <table border="1">
            <thead>
            <tr>
                <th>일정번호</th>
                <th>장소</th>
                <th>일정날자[Day]</th>
                <th>일정순서</th>
                <th>X</th>
                <th>Y</th>
                <th>내용</th>
            </tr>
            </thead>
            <tbody>
            <tr data-th-each="schedule, status : ${schedule}" data-th-object="${schedule}">
                <td><span data-th-text="*{scheduleNo}">번호</span></td>
                <td><span data-th-text="*{location.locationName}">장소</span></td>
                <td><span data-th-text="*{scheduleDay}">Day</span></td>
                <td><span data-th-text="*{scheduleRoute}">순서</span></td>
                <td><span data-th-text="*{location.locationX}">locationX</span></td>
                <td><span data-th-text="*{location.locationY}">locationY</span></td>
                <!-- 분리된 boardContent 내용을 각각의 textarea로 표시 -->
                <td>
                <textarea readonly rows="3" cols="30"
                          data-th-text="${#lists.size(board.boardContent.split('\n')) > status.index ? board.boardContent.split('\n')[status.index] : ''}">
                </textarea>
                </td>
            </tr>
            </tbody>
        </table>
        <br>


    <script>
        // const slides = document.querySelectorAll('.slide');
        // let currentSlideIndex = 0;
        //
        // // 첫 번째 이미지만 보여주기
        // showSlides(currentSlideIndex);
        //
        // // 슬라이드를 보여주는 함수
        // function showSlides(index) {
        //     // 순환 처리: 마지막 이미지를 넘어서면 처음으로, 첫 이미지를 넘어서면 마지막으로 돌아가기
        //     currentSlideIndex = (index + slides.length) % slides.length;
        //
        //     slides.forEach((slide, i) => {
        //         slide.style.display = (i === currentSlideIndex) ? 'block' : 'none';
        //     });
        // }
        //
        // // 슬라이드를 변경하는 함수
        // function changeSlide(n) {
        //     showSlides(currentSlideIndex + n);
        // }

        const slides = document.querySelectorAll('.slide');
        const paginationDots = document.getElementById('pagination-dots');
        let currentSlideIndex = 0;

        // 페이지 로드 시 네비게이션 점 생성
        slides.forEach((_, index) => {
            const dot = document.createElement('span');
            dot.innerText = '• ';
            dot.classList.add('pagination-dot');
            dot.style.cursor = 'pointer';
            dot.style.fontWeight = index === currentSlideIndex ? 'bold' : 'normal';  // 현재 슬라이드에 볼드 적용
            dot.onclick = () => showSlides(index);  // 클릭 시 해당 슬라이드로 이동
            paginationDots.appendChild(dot);
        });

        // 슬라이드를 보여주는 함수
        function showSlides(index) {
            currentSlideIndex = (index + slides.length) % slides.length;

            // 슬라이드 표시
            slides.forEach((slide, i) => {
                slide.style.display = (i === currentSlideIndex) ? 'block' : 'none';
            });

            // 네비게이션 점 스타일 업데이트
            const dots = document.querySelectorAll('.pagination-dot');
            dots.forEach((dot, i) => {
                dot.style.fontWeight = i === currentSlideIndex ? 'bold' : 'normal';
            });
        }

        // 슬라이드를 변경하는 함수
        function changeSlide(n) {
            showSlides(currentSlideIndex + n);
        }

        // 초기 슬라이드 설정
        showSlides(currentSlideIndex);
    </script>

<!--디버깅-->
        <p>디버깅용 : 로그인 유저: <span data-th-text="${session.loginUser.userNo}"></span></p>
        <p>디버깅용 : 게시글 작성자: <span data-th-text="${board.writer.userNo}"></span></p>



    <hr/>
    <br> 댓글: <br>

    <!-- 댓글이 없는 경우 -->
    <p data-th-unless="${commentList}" data-th-text="${'댓글이 없습니다.'}">댓글이 없습니다.</p>

    <!-- 댓글이 있는 경우 -->
    <ul data-th-if="${commentList}">
        <li data-th-each="comment : ${commentList}">
            댓글 번호: <input readonly type="text" data-th-value="${comment.commentNo}" size="3">
            작성자 : <input readonly type="text" data-th-value="${comment.writer.userNickname}"><br>
            작성일: <input readonly type="text"
                        data-th-value="${#dates.format(comment.commentCreatedDate, 'yyyy-MM-dd HH:mm')}"><br>

            댓글: <input readonly type="text" data-th-value="${comment.commentContent}" size="50"><br>

            <button type="button"
                    data-th-if="${session.loginUser != null and session.loginUser.userNo == comment.userNo}"
                    data-th-onclick="updateComment([[${comment.commentNo}]], [[${comment.commentContent}]])">
                수정
            </button>

            <button type="button"
                    data-th-if="${session.loginUser != null and session.loginUser.userNo == comment.userNo}"
                    data-th-onclick="deleteComment([[${comment.commentNo}]], [[${board.boardNo}]], '3')">
                삭제
            </button>
            <br>
<!--            <button type="hidden">수정[예정(비활성화)]</button>-->
        </li>
    </ul>
</div>

<hr/>

<form id="commentForm" data-th-action="@{/comment/add}" method="post" onsubmit="return validateCommentForm()">
    <input type="hidden" name="boardType" value="3">
    <input type="hidden" name="userNo" data-th-value="${#httpSession.getAttribute('loginUser').userNo}">

    게시글 번호: <input type="text" readonly name="boardNo" data-th-value="${board.boardNo}"><br>
    작성자 : <input type="text" readonly name="userNickname" data-th-value="${#httpSession.getAttribute('loginUser').userNickname}"><br>
    댓글 내용 작성: <textarea name="commentContent" id="commentContent" placeholder="댓글을 입력하세요"></textarea><br>
    <button type="submit">댓글 작성</button>
</form>
<!--댓글 빈칸방지-->
<script>
    function validateCommentForm() {
        const commentContent = document.getElementById('commentContent').value.trim();

        if (commentContent === "") {
            Swal.fire({
                icon: 'error',
                title: '댓글 내용이 비어 있습니다',
                text: '댓글 내용을 입력하세요.',
                confirmButtonText: '확인'
            });
            return false; // 폼 제출을 막습니다.
        }
        return true; // 폼을 제출합니다.
    }
</script>

<!--Script-->
<!--SweetAlert2 무조건 포함되어야함-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

<!--fontawesome-->
<script src="https://kit.fontawesome.com/ecaa6a7d50.js" crossorigin="anonymous"></script>

<script data-th-inline="javascript">
    <!-- 게시글삭제 -->
    function deleteBoard(no) {
        Swal.fire({
            title: '해당글을 삭제하시겠습니까?',
            text: '다시 되돌릴 수 없습니다. 신중하세요.',
            icon: 'warning',

            showCancelButton: true, // cancel버튼 보이기. 기본은 원래 없음
            confirmButtonColor: '#3085d6', // confrim 버튼 색깔 지정
            cancelButtonColor: '#d33', // cancel 버튼 색깔 지정
            confirmButtonText: '승인', // confirm 버튼 텍스트 지정
            cancelButtonText: '취소', // cancel 버튼 텍스트 지정

            // reverseButtons: true, // 버튼 순서 거꾸로

        }).then(result => { // 만약 Promise리턴을 받으면,
            if (result.isConfirmed) { // 만약 모달창에서 confirm 버튼을 눌렀다면

                Swal.fire({
                    title: '삭제 완료되었습니다.',
                    text: '후기 삭제완료~!',
                    icon: 'success',
                }).then(result => {
                    location.href = "delete?boardNo=" + no;
                });
            }
        });
    }

    <!-- 댓글 업데이트 -->
    function updateComment(commentNo, currentContent) {
        Swal.fire({
            title: '댓글 수정',
            input: 'textarea',
            inputLabel: '수정할 내용을 입력하세요',
            inputValue: currentContent,
            showCancelButton: true,
            confirmButtonText: '수정',
            cancelButtonText: '취소',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            inputValidator: (value) => {
                if (!value) {
                    return '내용을 입력해주세요!';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // 댓글 업데이트 요청
                fetch(`../comment/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        commentNo: commentNo,
                        content: result.value
                    }),
                })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '댓글이 수정되었습니다.',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            // 페이지 새로고침
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: '댓글 수정에 실패했습니다.',
                            text: data.message,
                        });
                    }
                })
                .catch((error) => {
                    console.error('댓글 수정 실패:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '댓글 수정 중 오류가 발생했습니다.',
                        text: '다시 시도해 주세요.',
                    });
                });
            }
        });
    }

    <!-- 댓글 삭제 -->
    function deleteComment(commentNo, boardNo, boardType) {
        Swal.fire({
            title: '댓글을 삭제하시겠습니까?',
            text: '다시 되돌릴 수 없습니다. 신중하세요.',
            icon: 'warning',

            showCancelButton: true, // cancel버튼 보이기. 기본은 원래 없음
            confirmButtonColor: '#3085d6', // confrim 버튼 색깔 지정
            cancelButtonColor: '#d33', // cancel 버튼 색깔 지정
            confirmButtonText: '승인', // confirm 버튼 텍스트 지정
            cancelButtonText: '취소', // cancel 버튼 텍스트 지정

            // reverseButtons: true, // 버튼 순서 거꾸로

        }).then(result => { // 만약 Promise리턴을 받으면,
            if (result.isConfirmed) { // 만약 모달창에서 confirm 버튼을 눌렀다면

                Swal.fire({
                    title: '삭제 완료되었습니다.',
                    text: '댓글삭제완료~!',
                    icon: 'success',
                }).then(result => {
                    location.href = `../comment/delete?commentNo=${commentNo}&boardNo=${boardNo}&boardType=${boardType}`;
                });
            }
        });
    }

    // 좋아요 토글 함수
    async function toggleLike(boardNo) {
        try {
            const response = await fetch(`like/${boardNo}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });

            const result = await response.json();

            if (response.ok) {
                // UI 업데이트: 좋아요 버튼 및 카운트 변경
                const likeButton = document.getElementById('likeButton');
                const likeCount = document.getElementById('likeCount');

                likeButton.textContent = result.isLiked ? '❤️ 좋아요 취소' : '🤍 좋아요';
                likeCount.textContent = result.likeCount;

                // 성공 토스트 메시지
                Swal.fire({
                    toast: true,
                    position: 'top-start',
                    icon: 'success',
                    title: '좋아요 상태가 변경되었습니다.',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true,});
            } else {
                // alert(result.message || '좋아요 처리 중 오류가 발생했습니다.');

                // 오류 토스트 메시지
                Swal.fire({
                    toast: true,
                    position: 'top-start',
                    icon: 'error',
                    title: result.message || '좋아요 처리 중 오류가 발생했습니다.',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true,
                });
            }
        } catch (error) {
            console.error('좋아요 요청 실패:', error);
            // alert('네트워크 오류가 발생했습니다. 다시 시도해 주세요.');
            // 네트워크 오류 토스트 메시지
            Swal.fire({
                toast: true,
                position: 'top-start',
                icon: 'error',
                title: '네트워크 오류가 발생했습니다. 다시 시도해 주세요.',
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true,
            });
        }
    }

    // 즐겨찾기 토글 함수
    async function toggleFavor(boardNo) {
        try {
            const response = await fetch(`favor/${boardNo}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });

            const result = await response.json();

            if (response.ok) {
                // UI 업데이트: 좋아요 버튼 및 카운트 변경
                const favorButton = document.getElementById('favorButton');
                const favorCount = document.getElementById('favorCount');

                favorButton.textContent = result.isFavored ? '⭐ 즐겨찾기 취소' : '⚪ 즐겨찾기';
                favorCount.textContent = result.favorCount;

                // 성공 토스트 메시지
                Swal.fire({
                    toast: true,
                    position: 'top-start',
                    icon: 'success',
                    title: '즐겨찾기 상태가 변경되었습니다.',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true,
                });
            } else {
                // alert(result.message || '즐겨찾기 처리 중 오류가 발생했습니다.');
                // 오류 토스트 메시지
                Swal.fire({
                    toast: true,
                    position: 'top-start',
                    icon: 'error',
                    title: result.message || '즐겨찾기 처리 중 오류가 발생했습니다.',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true,
                });
            }
        } catch (error) {
            console.error('즐겨찾기 요청 실패:', error);
            // alert('네트워크 오류가 발생했습니다. 다시 시도해 주세요.');
            // 네트워크 오류 토스트 메시지
            Swal.fire({
                toast: true,
                position: 'top-start',
                icon: 'error',
                title: '네트워크 오류가 발생했습니다. 다시 시도해 주세요.',
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true,
            });
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // 서버에서 전달된 상태 및 도시 이름을 가져옴 (예: board.trip.city.state.stateName 및 board.trip.city.cityName)
        // const stateName = /*[[${board.trip.city.state.stateName}]]*/ "defaultState";
        // const cityName = /*[[${board.trip.city.cityName}]]*/ "defaultCity";

        const stateName = "제주도";
        const cityName = "제주시 ";

        // 마커리스트 초기화
        markerList = [];

        let locationX=126.545219;
        let locationY=33.524923;
        if (locationX && locationY) {
            addMarker(parseFloat(locationX), parseFloat(locationY));
        }
        // 마커 좌표 설정


        // 지도초기화
        initializeMap("map", stateName, cityName);
    });


</script>

<!-- Bootstrap JS 및 종속성 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!--Naver MAP API-->
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0zojwabqn9&submodules=geocoder"></script>
<script data-th-src="@{/js/mapUtils.js}"></script>
</body>
</html>
